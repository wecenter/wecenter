<?php/*+--------------------------------------------------------------------------|   Anwsion [#RELEASE_VERSION#]|   ========================================|   by Anwsion dev team|   (c) 2011 - 2012 Anwsion Software|   http://www.anwsion.com|   ========================================|   Support: zhengqiang@gmail.com|   +---------------------------------------------------------------------------*/if (!defined('IN_ANWSION')){	die;}class setting extends AWS_CONTROLLER{	public function setup()	{		$this->model('admin_session')->init();	}	public function index_action()	{		$this->setting_action();	}	public function setting_action()	{		$settings_menu = array(			101 => 'site_info',			102 => 'reg_visit',			103 => 'site_func',			104 => 'content',			106 => 'integral_reputation', 			107 => 'email', 			108 => 'open', 			109 => 'cache', 			110 => 'sys_info', 			201 => 'view_set', 			305 => 'sensitive_words', 			404 => 'user_reputation', 			111 => 'user_privilege',			203 => 'editor',			603 => 'today_topics',		);				if (!in_array($_GET['type'], $settings_menu))		{			HTTP::redirect('?/admin/main/');		}				if ($_GET['type'] == 'view_set')		{			TPL::assign('styles', $this->model('setting')->get_ui_styles());		}				if ($_GET['type'] == 'reg_visit')		{						TPL::assign('notification_settings', get_setting('new_user_notification_setting'));			TPL::assign('notify_actions', $this->model('notify')->notify_action_details);		}				$this->crumb(AWS_APP::lang()->_t('系统设置'), 'admin/setting/type-' . $_GET['type']);				TPL::import_js('admin/js/setting.js');				TPL::assign('setting', get_setting());				TPL::assign('menu_list', $this->model('admin_group')->get_menu_list($this->user_info['group_id'], array_search($_GET['type'], $settings_menu)));				TPL::output('admin/setting/' . $_GET['type']);	}			public function sys_save_ajax_action()	{				define('IN_AJAX', TRUE);				if ($_POST['upload_dir'] && preg_match('/(.*)\/$/i', $_POST['upload_dir']))		{			H::ajax_json_output(AWS_APP::RSM(null, '-1', AWS_APP::lang()->_t('上传文件存放绝对路径不能以 / 结尾')));		}				if ($_POST['upload_url'] && preg_match('/(.*)\/$/i', $_POST['upload_url']))		{			H::ajax_json_output(AWS_APP::RSM(null, '-1', AWS_APP::lang()->_t('上传目录外部访问 URL 地址不能以 / 结尾')));		}				if ($_POST['request_route_custom'])		{			$_POST['request_route_custom'] = trim($_POST['request_route_custom']);						if ($request_routes = explode("\n", $_POST['request_route_custom']))			{				foreach ($request_routes as $key => $val)				{					if (! strstr($val, '==='))					{						continue;					}										list($m, $n) = explode('===', $val);										if (substr($n, 0, 1) != '/' || substr($m, 0, 1) != '/')					{						H::ajax_json_output(AWS_APP::RSM(null, -1, AWS_APP::lang()->_t('URL 自定义路由规则 URL 必须以 / 开头')));					}										if (strstr($m, '/admin') || strstr($n, '/admin'))					{						H::ajax_json_output(AWS_APP::RSM(null, -1, AWS_APP::lang()->_t('URL 自定义路由规则不允许设置 /admin 路由')));					}				}			}		}				if ($_POST['censoruser'])		{			$_POST['censoruser'] = trim($_POST['censoruser']);		}				if ($_POST['report_reason'])		{			$_POST['report_reason'] = trim($_POST['report_reason']);		}				if ($_POST['sensitive_words'])		{			$_POST['sensitive_words'] = trim($_POST['sensitive_words']);		}				$curl_require_setting = array('qq_login_enabled', 'sina_weibo_enabled', 'qq_t_enabled');				if (array_intersect(array_keys($_POST), $curl_require_setting))		{			foreach ($curl_require_setting as $key)			{				if ($_POST[$key] == 'Y' && !function_exists('curl_init'))				{					H::ajax_json_output(AWS_APP::RSM(null, -1, AWS_APP::lang()->_t('微博登录、QQ 登录等功能须服务器支持 CURL')));				}			}		}				if (!$_POST['newer_content_type'])		{			$_POST['newer_content_type'] = array();		}				if ($_POST['set_notification_settings'])		{			if ($notify_actions = $this->model('notify')->notify_action_details)			{				$notification_setting = array();								foreach ($notify_actions as $key => $val)				{					if (! isset($_POST['new_user_notification_setting'][$key]) && $val['user_setting'])					{						$notification_setting[] = intval($key);					}				}			}						$_POST['new_user_notification_setting'] = $notification_setting;		}				if ($_POST['set_email_settings'])		{						$email_settings = array(				'FOLLOW_ME' => 'N',				'QUESTION_INVITE' => 'N',				'NEW_ANSWER' => 'N',				'NEW_MESSAGE' => 'N',				'QUESTION_MOD' => 'N',			);							if ($_POST['new_user_email_setting'])			{				foreach ($_POST['new_user_email_setting'] AS $key => $val)				{					unset($email_settings[$val]);				}			}						$_POST['new_user_email_setting'] = $email_settings;		}				$this->model('setting')->set_vars($this->model('setting')->check_vars($_POST));				H::ajax_json_output(AWS_APP::RSM(null, 1, AWS_APP::lang()->_t('系统设置修改成功')));	}	public function test_email_setting_action()	{		define('IN_AJAX', TRUE);				$smtp_config = array(			'smtp_server' => $_POST['smtp_server'], 			'smtp_ssl' => $_POST['smtp_ssl'], 			'smtp_port' => $_POST['smtp_port'], 			'smtp_username' => $_POST['smtp_username'], 			'smtp_password' => $_POST['smtp_password']		);				$core_mail = new core_mail();				$connect_result = $core_mail->connect($_POST['email_type'], $smtp_config);				if (is_string($connect_result))		{			H::ajax_json_output(AWS_APP::RSM(null, -1, AWS_APP::lang()->_t('邮件服务器连接失败, 返回的信息: %s', strip_tags($connect_result))));		}				$sendmail_result = $core_mail->send_mail(get_setting('site_name'), $_POST['test_email'], $_POST['test_email'], get_setting('site_name') . ' - ' . AWS_APP::lang()->_t('邮件服务器配置测试'), AWS_APP::lang()->_t('这是一封测试邮件，收到邮件表示邮件服务器配置成功'));				if (is_object($sendmail_result))		{						H::ajax_json_output(AWS_APP::RSM(null, 1, AWS_APP::lang()->_t('测试邮件已发送, 请查收邮件测试配置是否正确')));		}		else		{			H::ajax_json_output(AWS_APP::RSM(null, 1, AWS_APP::lang()->_t('测试邮件发送失败, 返回的信息: %s', strip_tags($sendmail_result))));		}	}}