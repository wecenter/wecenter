<?php/*+--------------------------------------------------------------------------|   WeCenter [#RELEASE_VERSION#]|   ========================================|   by WeCenter Software|   © 2011 - 2013 WeCenter. All Rights Reserved|   http://www.wecenter.com|   ========================================|   Support: WeCenter@qq.com|   +---------------------------------------------------------------------------*/define('IN_AJAX', TRUE);if (!defined('IN_ANWSION')){	die;}define('IN_MOBILE', true);class ajax extends AWS_CONTROLLER{	var $per_page = 20;		public function get_access_rule()	{		$rule_action['rule_type'] = 'white';		$rule_action['actions'] = array();				return $rule_action;	}		public function setup()	{		HTTP::no_cache_header();	}		public function inbox_list_action()	{		if ($inbox_dialog = $this->model('message')->get_inbox_message($_GET['page'], get_setting('contents_per_page'), $this->user_id))		{			foreach ($inbox_dialog as $key => $val)			{				$dialog_ids[] = $val['id'];				if ($this->user_id == $val['recipient_uid'])				{					$inbox_dialog_uids[] = $val['sender_uid'];				}				else				{					$inbox_dialog_uids[] = $val['recipient_uid'];				}			}		}						if ($inbox_dialog_uids)		{			if ($users_info_query = $this->model('account')->get_user_info_by_uids($inbox_dialog_uids))			{				foreach ($users_info_query as $user)				{					$users_info[$user['uid']] = $user;				}			}		}				if ($dialog_ids)		{			$last_message = $this->model('message')->get_last_messages($dialog_ids);		}						if ($inbox_dialog)		{			foreach ($inbox_dialog as $key => $value)			{				if ($value['sender_uid'] == $this->user_id AND $value['sender_count']) // 当前处于发送用户				{					$data[$key]['user_name'] = $users_info[$value['recipient_uid']]['user_name'];					$data[$key]['url_token'] = $users_info[$value['recipient_uid']]['url_token'];										$data[$key]['unread'] = $value['sender_unread'];					$data[$key]['count'] = $value['sender_count'];					$data[$key]['uid'] = $value['recipient_uid'];				}				else if ($value['recipient_uid'] == $this->user_id AND $value['recipient_count']) // 当前处于接收用户				{					$data[$key]['user_name'] = $users_info[$value['sender_uid']]['user_name'];					$data[$key]['url_token'] = $users_info[$value['sender_uid']]['url_token'];										$data[$key]['unread'] = $value['recipient_unread'];					$data[$key]['count'] = $value['recipient_count'];										$data[$key]['uid'] = $value['sender_uid'];				}								$data[$key]['last_message'] = $last_message[$value['id']];								$data[$key]['update_time'] = $value['update_time'];								$data[$key]['id'] = $value['id'];			}		}				TPL::assign('list', $data);		TPL::output('m/ajax/inbox_list');	}		public function focus_topics_list_action()	{		if ($topics_list = $this->model('topic')->get_focus_topic_list($this->user_id, intval($_GET['page']) * 5 . ', ' . 5))		{			foreach ($topics_list AS $key => $val)			{				$topics_list[$key]['action_list'] = $this->model('posts')->get_posts_list('question', 1, 3, 'new', explode(',', $val['topic_id']));			}		}				TPL::assign('topics_list', $topics_list);				TPL::output('m/ajax/focus_topics_list');	}}